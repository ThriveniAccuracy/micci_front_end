import { toggleMark } from 'prosemirror-commands';
import schema from '../../../schema';
import isNodeActive from '../../helpers/isNodeActive';
import isMarkActive from '../../helpers/isMarkActive';
import { toggleList, toggleBlockType } from '../../commands';
import { getIconSvg } from '../../../utils/icons';
import flatDeep from '../../../utils/flatDeep';
import menuItemsMeta from './meta';
const MENU_ITEM_CLASSNAME = 'NgxEditor-MenuItem';
const DROPDOWN_ITEMS = new Map();
DROPDOWN_ITEMS.set('heading', ['h1', 'h2', 'h3', 'h4', 'h5', 'h6']);
const isListItem = (type) => {
    return (type === schema.nodes.list_item ||
        type === schema.nodes.ordered_list ||
        type === schema.nodes.bullet_list);
};
const ɵ0 = isListItem;
class DropDownView {
    constructor(dropdownGroup, dropdownFields, editorView, options) {
        this.updates = [];
        this.dropdownGroup = dropdownGroup;
        this.dropdownFields = dropdownFields;
        this.editorView = editorView;
        this.options = options;
    }
    getWrapperDom() {
        let isDropdownOpen = false;
        const dropdownWrapper = document.createElement('div');
        const labels = this.options.labels;
        dropdownWrapper.classList.add(MENU_ITEM_CLASSNAME);
        dropdownWrapper.classList.add(`${MENU_ITEM_CLASSNAME}__Dropdown-Wrapper`);
        // create dropdown content
        const dropdown = document.createElement('div');
        dropdown.classList.add(`${MENU_ITEM_CLASSNAME}__Dropdown`);
        const dropdownText = document.createElement('div');
        dropdownText.classList.add(`${MENU_ITEM_CLASSNAME}__Dropdown-Text`);
        dropdownText.textContent = labels[this.dropdownGroup];
        const dropdownIcon = document.createElement('div');
        dropdownIcon.classList.add(`${MENU_ITEM_CLASSNAME}__Dropdown-Icon`);
        dropdownIcon.innerHTML = getIconSvg('arrow_drop_down');
        dropdown.appendChild(dropdownText);
        dropdown.appendChild(dropdownIcon);
        const dropdownOpenClassName = `${MENU_ITEM_CLASSNAME}__Dropdown-Wrapper-Open`;
        const mouseDownHandler = (e) => {
            e.preventDefault();
            if (!dropdownWrapper.contains(e.target)) {
                closeDropdown();
            }
        };
        const openDropdown = () => {
            dropdownWrapper.classList.add(dropdownOpenClassName);
            isDropdownOpen = true;
            window.addEventListener('mousedown', mouseDownHandler);
        };
        const closeDropdown = () => {
            dropdownWrapper.classList.remove(dropdownOpenClassName);
            isDropdownOpen = false;
            window.removeEventListener('mousedown', mouseDownHandler);
        };
        dropdown.addEventListener('click', (e) => {
            e.preventDefault();
            if (!isDropdownOpen) {
                openDropdown();
            }
            else {
                closeDropdown();
            }
        });
        // create dropdown list
        const dropdownList = document.createElement('div');
        dropdownList.classList.add(`${MENU_ITEM_CLASSNAME}__Dropdown-Menu`);
        this.dropdownFields.forEach(dropdownItem => {
            const menuItem = menuItemsMeta[dropdownItem];
            let text = labels[menuItem.key];
            if (menuItem.key === 'heading') {
                text += ` ${menuItem.attrs.level}`;
            }
            const spec = {
                classNames: [
                    `${MENU_ITEM_CLASSNAME}__Dropdown-Item`
                ],
                textContent: text,
                attrs: {
                    title: text
                }
            };
            const menuItemView = new MenuItemView(menuItem, this.editorView, spec);
            const { update, dom } = menuItemView.render();
            // remove open class once clicked on dropdown value
            dom.addEventListener('click', (e) => {
                e.preventDefault();
                closeDropdown();
            });
            // wrapper to execute when update is called
            const dropUpdate = (state) => {
                update(state);
                const selectedClass = `${MENU_ITEM_CLASSNAME}__Dropdown-Wrapper-Selected`;
                // update the dropdown content heading when a class is selected
                const activeEl = dropdownList.getElementsByClassName(`${MENU_ITEM_CLASSNAME}__Active`);
                if (activeEl.length) {
                    const el = activeEl[0];
                    dropdownText.textContent = el.textContent;
                    dropdownWrapper.classList.add(selectedClass);
                }
                else {
                    // restore default value
                    dropdownText.textContent = labels[this.dropdownGroup];
                    dropdownWrapper.classList.remove(selectedClass);
                }
            };
            dropdownList.appendChild(dom);
            this.updates.push(dropUpdate);
        });
        dropdownWrapper.appendChild(dropdown);
        dropdownWrapper.appendChild(dropdownList);
        return dropdownWrapper;
    }
    render() {
        this.dom = this.getWrapperDom();
        return {
            dom: this.dom,
            updates: this.updates
        };
    }
}
class MenuItemView {
    constructor(menuItem, editorView, spec) {
        this.menuItem = menuItem;
        this.editorView = editorView;
        this.spec = spec;
    }
    render() {
        const dom = this.dom = this.getDom();
        this.setupCommandListeners();
        const update = (state) => {
            const menuItem = this.menuItem;
            let isActive = false;
            if (menuItem.type === 'mark') {
                const type = schema.marks[menuItem.key];
                isActive = isMarkActive(state, type);
            }
            if (menuItem.type === 'node') {
                const type = schema.nodes[menuItem.key];
                isActive = isNodeActive(state, type, menuItem.attrs);
            }
            dom.classList.toggle(`${MENU_ITEM_CLASSNAME}__Active`, isActive);
        };
        return {
            dom,
            update
        };
    }
    getDom() {
        const div = document.createElement('div');
        if (this.spec.classNames) {
            this.spec.classNames.forEach(className => {
                div.classList.add(className);
            });
        }
        if (this.spec.attrs) {
            Object.entries(this.spec.attrs).forEach(obj => {
                div.setAttribute(obj[0], obj[1]);
            });
        }
        if (this.spec.innerHTML) {
            div.innerHTML = this.spec.innerHTML;
        }
        if (this.spec.textContent) {
            div.innerHTML = this.spec.textContent;
        }
        return div;
    }
    setupCommandListeners() {
        this.dom.addEventListener('mousedown', (e) => {
            e.preventDefault();
            // don't execute if not left click
            if (e.buttons !== 1) {
                return;
            }
            if (this.menuItem.type === 'mark') {
                const command = toggleMark(schema.marks[this.menuItem.key]);
                command(this.editorView.state, this.editorView.dispatch);
                return;
            }
            if (this.menuItem.type === 'node') {
                const type = schema.nodes[this.menuItem.key];
                if (isListItem(type)) {
                    const command = toggleList(type, schema.nodes.list_item);
                    command(this.editorView.state, this.editorView.dispatch);
                    return;
                }
                if (type === schema.nodes.heading) {
                    const command = toggleBlockType(type, schema.nodes.paragraph, { level: this.menuItem.attrs.level });
                    command(this.editorView.state, this.editorView.dispatch);
                    return;
                }
            }
        });
    }
}
const getSeperatorDom = () => {
    const div = document.createElement('div');
    div.className = `${MENU_ITEM_CLASSNAME}__Seperator`;
    return div;
};
const ɵ1 = getSeperatorDom;
export const renderMenu = (options, editorView, menuDom) => {
    const updates = [];
    const toolbar = options.toolbar;
    toolbar.forEach((group, toolbarIndex) => {
        const isLastMenuGroup = toolbar.length - 1 === toolbarIndex;
        group.forEach((toolbarItem, menuIndex) => {
            const isLastMenuItem = group.length - 1 === menuIndex;
            // render dropdown
            if (typeof toolbarItem === 'object') {
                Object.keys(toolbarItem).forEach((dropdownGroup) => {
                    if (DROPDOWN_ITEMS.has(dropdownGroup)) {
                        const dropdown = toolbarItem[dropdownGroup];
                        const dropdownView = new DropDownView(dropdownGroup, dropdown, editorView, options);
                        const rendered = dropdownView.render();
                        updates.push(rendered.updates);
                        menuDom.appendChild(rendered.dom);
                    }
                    else {
                        console.warn('Unkown dropdown group:', dropdownGroup);
                    }
                });
            }
            // render Icons
            if (typeof toolbarItem === 'string') {
                const menuItem = menuItemsMeta[toolbarItem];
                const labels = options.labels;
                if (menuItem) {
                    const spec = {
                        classNames: [
                            MENU_ITEM_CLASSNAME,
                            `${MENU_ITEM_CLASSNAME}__Icon`,
                            `${MENU_ITEM_CLASSNAME}__${menuItem.key}`
                        ],
                        innerHTML: getIconSvg(menuItem.icon),
                        attrs: {
                            title: labels[menuItem.i18nKey]
                        }
                    };
                    const menuItemView = new MenuItemView(menuItem, editorView, spec);
                    const { update, dom } = menuItemView.render();
                    menuDom.appendChild(dom);
                    updates.push(update);
                }
            }
            if (isLastMenuItem && !isLastMenuGroup) {
                const seperatorDom = getSeperatorDom();
                menuDom.appendChild(seperatorDom);
            }
        });
    });
    const combinedUpdates = flatDeep(updates, Infinity);
    return {
        update(state) {
            combinedUpdates.forEach((update) => {
                update(state);
            });
        }
    };
};
export { ɵ0, ɵ1 };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWVudS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL25neC1lZGl0b3IvIiwic291cmNlcyI6WyJsaWIvcHJvc2VtaXJyb3IvcGx1Z2lucy9tZW51L21lbnUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBYWxELE9BQU8sTUFBTSxNQUFNLGlCQUFpQixDQUFDO0FBRXJDLE9BQU8sWUFBWSxNQUFNLDRCQUE0QixDQUFDO0FBQ3RELE9BQU8sWUFBWSxNQUFNLDRCQUE0QixDQUFDO0FBQ3RELE9BQU8sRUFBRSxVQUFVLEVBQUUsZUFBZSxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFFN0QsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBQ2xELE9BQU8sUUFBUSxNQUFNLHlCQUF5QixDQUFDO0FBRS9DLE9BQU8sYUFBNkIsTUFBTSxRQUFRLENBQUM7QUFFbkQsTUFBTSxtQkFBbUIsR0FBRyxvQkFBb0IsQ0FBQztBQUVqRCxNQUFNLGNBQWMsR0FBRyxJQUFJLEdBQUcsRUFBRSxDQUFDO0FBQ2pDLGNBQWMsQ0FBQyxHQUFHLENBQUMsU0FBUyxFQUFFLENBQUMsSUFBSSxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxJQUFJLENBQUMsQ0FBQyxDQUFDO0FBRXBFLE1BQU0sVUFBVSxHQUFHLENBQUMsSUFBYyxFQUFFLEVBQUU7SUFDcEMsT0FBTyxDQUNMLElBQUksS0FBSyxNQUFNLENBQUMsS0FBSyxDQUFDLFNBQVM7UUFDL0IsSUFBSSxLQUFLLE1BQU0sQ0FBQyxLQUFLLENBQUMsWUFBWTtRQUNsQyxJQUFJLEtBQUssTUFBTSxDQUFDLEtBQUssQ0FBQyxXQUFXLENBQ2xDLENBQUM7QUFDSixDQUFDLENBQUM7O0FBRUYsTUFBTSxZQUFZO0lBVWhCLFlBQ0UsYUFBdUMsRUFDdkMsY0FBMEMsRUFDMUMsVUFBc0IsRUFDdEIsT0FBb0I7UUFOdEIs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Q0FBQzthQUNuQztRQUNILENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQyxDQUFDLENBQUM7SUFFSCxNQUFNLGVBQWUsR0FBRyxRQUFRLENBQUMsT0FBTyxFQUFFLFFBQVEsQ0FBQyxDQUFDO0lBRXBELE9BQU87UUFDTCxNQUFNLENBQUMsS0FBa0I7WUFDdkIsZUFBZSxDQUFDLE9BQU8sQ0FBQyxDQUFDLE1BQW9DLEVBQUUsRUFBRTtnQkFDL0QsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDO1lBQ2hCLENBQUMsQ0FBQyxDQUFDO1FBQ0wsQ0FBQztLQUNGLENBQUM7QUFDSixDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyB0b2dnbGVNYXJrIH0gZnJvbSAncHJvc2VtaXJyb3ItY29tbWFuZHMnO1xuaW1wb3J0IHsgRWRpdG9yVmlldyB9IGZyb20gJ3Byb3NlbWlycm9yLXZpZXcnO1xuaW1wb3J0IHsgRWRpdG9yU3RhdGUgfSBmcm9tICdwcm9zZW1pcnJvci1zdGF0ZSc7XG5pbXBvcnQgeyBNYXJrVHlwZSwgTm9kZVR5cGUgfSBmcm9tICdwcm9zZW1pcnJvci1tb2RlbCc7XG5cbmltcG9ydCB7XG4gIE1lbnVJdGVtVmlld1NwZWMsXG4gIFRvb2xiYXJJdGVtLFxuICBUb29sYmFyRHJvcGRvd25Hcm91cEtleXMsXG4gIFRvb2xiYXJEcm9wZG93bkdyb3VwVmFsdWVzLFxuICBNZW51T3B0aW9uc1xufSBmcm9tICcuLi8uLi8uLi90eXBlcyc7XG5cbmltcG9ydCBzY2hlbWEgZnJvbSAnLi4vLi4vLi4vc2NoZW1hJztcblxuaW1wb3J0IGlzTm9kZUFjdGl2ZSBmcm9tICcuLi8uLi9oZWxwZXJzL2lzTm9kZUFjdGl2ZSc7XG5pbXBvcnQgaXNNYXJrQWN0aXZlIGZyb20gJy4uLy4uL2hlbHBlcnMvaXNNYXJrQWN0aXZlJztcbmltcG9ydCB7IHRvZ2dsZUxpc3QsIHRvZ2dsZUJsb2NrVHlwZSB9IGZyb20gJy4uLy4uL2NvbW1hbmRzJztcblxuaW1wb3J0IHsgZ2V0SWNvblN2ZyB9IGZyb20gJy4uLy4uLy4uL3V0aWxzL2ljb25zJztcbmltcG9ydCBmbGF0RGVlcCBmcm9tICcuLi8uLi8uLi91dGlscy9mbGF0RGVlcCc7XG5cbmltcG9ydCBtZW51SXRlbXNNZXRhLCB7TWVudUl0ZW1NZXRhfSBmcm9tICcuL21ldGEnO1xuXG5jb25zdCBNRU5VX0lURU1fQ0xBU1NOQU1FID0gJ05neEVkaXRvci1NZW51SXRlbSc7XG5cbmNvbnN0IERST1BET1dOX0lURU1TID0gbmV3IE1hcCgpO1xuRFJPUERPV05fSVRFTVMuc2V0KCdoZWFkaW5nJywgWydoMScsICdoMicsICdoMycsICdoNCcsICdoNScsICdoNiddKTtcblxuY29uc3QgaXNMaXN0SXRlbSA9ICh0eXBlOiBOb2RlVHlwZSkgPT4ge1xuICByZXR1cm4gKFxuICAgIHR5cGUgPT09IHNjaGVtYS5ub2Rlcy5saXN0X2l0ZW0gfHxcbiAgICB0eXBlID09PSBzY2hlbWEubm9kZXMub3JkZXJlZF9saXN0IHx8XG4gICAgdHlwZSA9PT0gc2NoZW1hLm5vZGVzLmJ1bGxldF9saXN0XG4gICk7XG59O1xuXG5jbGFzcyBEcm9wRG93blZpZXcge1xuICBwcml2YXRlIGRyb3Bkb3duR3JvdXA6IFRvb2xiYXJEcm9wZG93bkdyb3VwS2V5cztcbiAgcHJpdmF0ZSBkcm9wZG93bkZpZWxkczogVG9vbGJhckRyb3Bkb3duR3JvdXBWYWx1ZXM7XG4gIHByaXZhdGUgZWRpdG9yVmlldzogRWRpdG9yVmlldztcbiAgcHJpdmF0ZSBvcHRpb25zOiBNZW51T3B0aW9ucztcblxuICBkb206IEhUTUxFbGVtZW50O1xuXG4gIHVwZGF0ZXMgPSBbXTtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBkcm9wZG93bkdyb3VwOiBUb29sYmFyRHJvcGRvd25Hcm91cEtleXMsXG4gICAgZHJvcGRvd25GaWVsZHM6IFRvb2xiYXJEcm9wZG93bkdyb3VwVmFsdWVzLFxuICAgIGVkaXRvclZpZXc6IEVkaXRvclZpZXcsXG4gICAgb3B0aW9uczogTWVudU9wdGlvbnNcbiAgKSB7XG4gICAgdGhpcy5kcm9wZG93bkdyb3VwID0gZHJvcGRvd25Hcm91cDtcbiAgICB0aGlzLmRyb3Bkb3duRmllbGRzID0gZHJvcGRvd25GaWVsZHM7XG4gICAgdGhpcy5lZGl0b3JWaWV3ID0gZWRpdG9yVmlldztcbiAgICB0aGlzLm9wdGlvbnMgPSBvcHRpb25zO1xuICB9XG5cbiAgZ2V0V3JhcHBlckRvbSgpOiBIVE1MRWxlbWVudCB7XG4gICAgbGV0IGlzRHJvcGRvd25PcGVuID0gZmFsc2U7XG4gICAgY29uc3QgZHJvcGRvd25XcmFwcGVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7XG5cbiAgICBjb25zdCBsYWJlbHMgPSB0aGlzLm9wdGlvbnMubGFiZWxzO1xuXG4gICAgZHJvcGRvd25XcmFwcGVyLmNsYXNzTGlzdC5hZGQoTUVOVV9JVEVNX0NMQVNTTkFNRSk7XG4gICAgZHJvcGRvd25XcmFwcGVyLmNsYXNzTGlzdC5hZGQoYCR7TUVOVV9JVEVNX0NMQVNTTkFNRX1fX0Ryb3Bkb3duLVdyYXBwZXJgKTtcblxuICAgIC8vIGNyZWF0ZSBkcm9wZG93biBjb250ZW50XG4gICAgY29uc3QgZHJvcGRvd24gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTtcbiAgICBkcm9wZG93bi5jbGFzc0xpc3QuYWRkKGAke01FTlVfSVRFTV9DTEFTU05BTUV9X19Ecm9wZG93bmApO1xuXG4gICAgY29uc3QgZHJvcGRvd25UZXh0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7XG4gICAgZHJvcGRvd25UZXh0LmNsYXNzTGlzdC5hZGQoYCR7TUVOVV9JVEVNX0NMQVNTTkFNRX1fX0Ryb3Bkb3duLVRleHRgKTtcbiAgICBkcm9wZG93blRleHQudGV4dENvbnRlbnQgPSBsYWJlbHNbdGhpcy5kcm9wZG93bkdyb3VwXTtcblxuICAgIGNvbnN0IGRyb3Bkb3duSWNvbiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpO1xuICAgIGRyb3Bkb3duSWNvbi5jbGFzc0xpc3QuYWRkKGAke01FTlVfSVRFTV9DTEFTU05BTUV9X19Ecm9wZG93bi1JY29uYCk7XG4gICAgZHJvcGRvd25JY29uLmlubmVySFRNTCA9IGdldEljb25TdmcoJ2Fycm93X2Ryb3BfZG93bicpO1xuXG4gICAgZHJvcGRvd24uYXBwZW5kQ2hpbGQoZHJvcGRvd25UZXh0KTtcbiAgICBkcm9wZG93bi5hcHBlbmRDaGlsZChkcm9wZG93bkljb24pO1xuXG4gICAgY29uc3QgZHJvcGRvd25PcGVuQ2xhc3NOYW1lID0gYCR7TUVOVV9JVEVNX0NMQVNTTkFNRX1fX0Ryb3Bkb3duLVdyYXBwZXItT3BlbmA7XG5cbiAgICBjb25zdCBtb3VzZURvd25IYW5kbGVyID0gKGU6IE1vdXNlRXZlbnQpID0+IHtcbiAgICAgIGUucHJldmVudERlZmF1bHQoKTtcbiAgICAgIGlmICghZHJvcGRvd25XcmFwcGVyLmNvbnRhaW5zKGUudGFyZ2V0IGFzIE5vZGUpKSB7XG4gICAgICAgIGNsb3NlRHJvcGRvd24oKTtcbiAgICAgIH1cbiAgICB9O1xuXG4gICAgY29uc3Qgb3BlbkRyb3Bkb3duID0gKCkgPT4ge1xuICAgICAgZHJvcGRvd25XcmFwcGVyLmNsYXNzTGlzdC5hZGQoZHJvcGRvd25PcGVuQ2xhc3NOYW1lKTtcbiAgICAgIGlzRHJvcGRvd25PcGVuID0gdHJ1ZTtcbiAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdtb3VzZWRvd24nLCBtb3VzZURvd25IYW5kbGVyKTtcbiAgICB9O1xuXG4gICAgY29uc3QgY2xvc2VEcm9wZG93biA9ICgpID0+IHtcbiAgICAgIGRyb3Bkb3duV3JhcHBlci5jbGFzc0xpc3QucmVtb3ZlKGRyb3Bkb3duT3BlbkNsYXNzTmFtZSk7XG4gICAgICBpc0Ryb3Bkb3duT3BlbiA9IGZhbHNlO1xuICAgICAgd2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ21vdXNlZG93bicsIG1vdXNlRG93bkhhbmRsZXIpO1xuICAgIH07XG5cbiAgICBkcm9wZG93bi5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIChlOiBNb3VzZUV2ZW50KSA9PiB7XG4gICAgICBlLnByZXZlbnREZWZhdWx0KCk7XG4gICAgICBpZiAoIWlzRHJvcGRvd25PcGVuKSB7XG4gICAgICAgIG9wZW5Ecm9wZG93bigpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgY2xvc2VEcm9wZG93bigpO1xuICAgICAgfVxuICAgIH0pO1xuXG4gICAgLy8gY3JlYXRlIGRyb3Bkb3duIGxpc3RcbiAgICBjb25zdCBkcm9wZG93bkxpc3QgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTtcbiAgICBkcm9wZG93bkxpc3QuY2xhc3NMaXN0LmFkZChgJHtNRU5VX0lURU1fQ0xBU1NOQU1FfV9fRHJvcGRvd24tTWVudWApO1xuXG4gICAgdGhpcy5kcm9wZG93bkZpZWxkcy5mb3JFYWNoKGRyb3Bkb3duSXRlbSA9PiB7XG4gICAgICBjb25zdCBtZW51SXRlbSA9IG1lbnVJdGVtc01ldGFbZHJvcGRvd25JdGVtXTtcblxuICAgICAgbGV0IHRleHQgPSBsYWJlbHNbbWVudUl0ZW0ua2V5XTtcblxuICAgICAgaWYgKG1lbnVJdGVtLmtleSA9PT0gJ2hlYWRpbmcnKSB7XG4gICAgICAgIHRleHQgKz0gYCAke21lbnVJdGVtLmF0dHJzLmxldmVsfWA7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IHNwZWM6IE1lbnVJdGVtVmlld1NwZWMgPSB7XG4gICAgICAgIGNsYXNzTmFtZXM6IFtcbiAgICAgICAgICBgJHtNRU5VX0lURU1fQ0xBU1NOQU1FfV9fRHJvcGRvd24tSXRlbWBcbiAgICAgICAgXSxcbiAgICAgICAgdGV4dENvbnRlbnQ6IHRleHQsXG4gICAgICAgIGF0dHJzOiB7XG4gICAgICAgICAgdGl0bGU6IHRleHRcbiAgICAgICAgfVxuICAgICAgfTtcblxuICAgICAgY29uc3QgbWVudUl0ZW1WaWV3ID0gbmV3IE1lbnVJdGVtVmlldyhtZW51SXRlbSwgdGhpcy5lZGl0b3JWaWV3LCBzcGVjKTtcbiAgICAgIGNvbnN0IHsgdXBkYXRlLCBkb20gfSA9IG1lbnVJdGVtVmlldy5yZW5kZXIoKTtcblxuICAgICAgLy8gcmVtb3ZlIG9wZW4gY2xhc3Mgb25jZSBjbGlja2VkIG9uIGRyb3Bkb3duIHZhbHVlXG4gICAgICBkb20uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoZTogTW91c2VFdmVudCkgPT4ge1xuICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7XG4gICAgICAgIGNsb3NlRHJvcGRvd24oKTtcbiAgICAgIH0pO1xuXG4gICAgICAvLyB3cmFwcGVyIHRvIGV4ZWN1dGUgd2hlbiB1cGRhdGUgaXMgY2FsbGVkXG4gICAgICBjb25zdCBkcm9wVXBkYXRlID0gKHN0YXRlOiBFZGl0b3JTdGF0ZSkgPT4ge1xuICAgICAgICB1cGRhdGUoc3RhdGUpO1xuXG4gICAgICAgIGNvbnN0IHNlbGVjdGVkQ2xhc3MgPSBgJHtNRU5VX0lURU1fQ0xBU1NOQU1FfV9fRHJvcGRvd24tV3JhcHBlci1TZWxlY3RlZGA7XG5cbiAgICAgICAgLy8gdXBkYXRlIHRoZSBkcm9wZG93biBjb250ZW50IGhlYWRpbmcgd2hlbiBhIGNsYXNzIGlzIHNlbGVjdGVkXG4gICAgICAgIGNvbnN0IGFjdGl2ZUVsID0gZHJvcGRvd25MaXN0LmdldEVsZW1lbnRzQnlDbGFzc05hbWUoYCR7TUVOVV9JVEVNX0NMQVNTTkFNRX1fX0FjdGl2ZWApO1xuICAgICAgICBpZiAoYWN0aXZlRWwubGVuZ3RoKSB7XG4gICAgICAgICAgY29uc3QgZWwgPSBhY3RpdmVFbFswXTtcbiAgICAgICAgICBkcm9wZG93blRleHQudGV4dENvbnRlbnQgPSBlbC50ZXh0Q29udGVudDtcbiAgICAgICAgICBkcm9wZG93bldyYXBwZXIuY2xhc3NMaXN0LmFkZChzZWxlY3RlZENsYXNzKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAvLyByZXN0b3JlIGRlZmF1bHQgdmFsdWVcbiAgICAgICAgICBkcm9wZG93blRleHQudGV4dENvbnRlbnQgPSBsYWJlbHNbdGhpcy5kcm9wZG93bkdyb3VwXTtcbiAgICAgICAgICBkcm9wZG93bldyYXBwZXIuY2xhc3NMaXN0LnJlbW92ZShzZWxlY3RlZENsYXNzKTtcbiAgICAgICAgfVxuICAgICAgfTtcblxuICAgICAgZHJvcGRvd25MaXN0LmFwcGVuZENoaWxkKGRvbSk7XG4gICAgICB0aGlzLnVwZGF0ZXMucHVzaChkcm9wVXBkYXRlKTtcbiAgICB9KTtcblxuICAgIGRyb3Bkb3duV3JhcHBlci5hcHBlbmRDaGlsZChkcm9wZG93bik7XG4gICAgZHJvcGRvd25XcmFwcGVyLmFwcGVuZENoaWxkKGRyb3Bkb3duTGlzdCk7XG5cbiAgICByZXR1cm4gZHJvcGRvd25XcmFwcGVyO1xuICB9XG5cbiAgcmVuZGVyKCkge1xuICAgIHRoaXMuZG9tID0gdGhpcy5nZXRXcmFwcGVyRG9tKCk7XG5cbiAgICByZXR1cm4ge1xuICAgICAgZG9tOiB0aGlzLmRvbSxcbiAgICAgIHVwZGF0ZXM6IHRoaXMudXBkYXRlc1xuICAgIH07XG4gIH1cbn1cblxuY2xhc3MgTWVudUl0ZW1WaWV3IHtcbiAgcHJpdmF0ZSBtZW51SXRlbTogTWVudUl0ZW1NZXRhO1xuICBwcml2YXRlIGVkaXRvclZpZXc6IEVkaXRvclZpZXc7XG4gIHByaXZhdGUgc3BlYzogTWVudUl0ZW1WaWV3U3BlYztcblxuICBkb206IEhUTUxFbGVtZW50O1xuXG4gIGNvbnN0cnVjdG9yKG1lbnVJdGVtOiBNZW51SXRlbU1ldGEsIGVkaXRvclZpZXc6IEVkaXRvclZpZXcsIHNwZWM6IE1lbnVJdGVtVmlld1NwZWMpIHtcbiAgICB0aGlzLm1lbnVJdGVtID0gbWVudUl0ZW07XG4gICAgdGhpcy5lZGl0b3JWaWV3ID0gZWRpdG9yVmlldztcbiAgICB0aGlzLnNwZWMgPSBzcGVjO1xuICB9XG5cbiAgcmVuZGVyKCkge1xuICAgIGNvbnN0IGRvbSA9IHRoaXMuZG9tID0gdGhpcy5nZXREb20oKTtcbiAgICB0aGlzLnNldHVwQ29tbWFuZExpc3RlbmVycygpO1xuXG4gICAgY29uc3QgdXBkYXRlID0gKHN0YXRlOiBFZGl0b3JTdGF0ZSk6IHZvaWQgPT4ge1xuICAgICAgY29uc3QgbWVudUl0ZW0gPSB0aGlzLm1lbnVJdGVtO1xuICAgICAgbGV0IGlzQWN0aXZlID0gZmFsc2U7XG5cbiAgICAgIGlmIChtZW51SXRlbS50eXBlID09PSAnbWFyaycpIHtcbiAgICAgICAgY29uc3QgdHlwZTogTWFya1R5cGUgPSBzY2hlbWEubWFya3NbbWVudUl0ZW0ua2V5XTtcbiAgICAgICAgaXNBY3RpdmUgPSBpc01hcmtBY3RpdmUoc3RhdGUsIHR5cGUpO1xuICAgICAgfVxuXG4gICAgICBpZiAobWVudUl0ZW0udHlwZSA9PT0gJ25vZGUnKSB7XG4gICAgICAgIGNvbnN0IHR5cGU6IE5vZGVUeXBlID0gc2NoZW1hLm5vZGVzW21lbnVJdGVtLmtleV07XG4gICAgICAgIGlzQWN0aXZlID0gaXNOb2RlQWN0aXZlKHN0YXRlLCB0eXBlLCBtZW51SXRlbS5hdHRycyk7XG4gICAgICB9XG5cbiAgICAgIGRvbS5jbGFzc0xpc3QudG9nZ2xlKGAke01FTlVfSVRFTV9DTEFTU05BTUV9X19BY3RpdmVgLCBpc0FjdGl2ZSk7XG4gICAgfTtcblxuICAgIHJldHVybiB7XG4gICAgICBkb20sXG4gICAgICB1cGRhdGVcbiAgICB9O1xuICB9XG5cbiAgZ2V0RG9tKCk6IEhUTUxFbGVtZW50IHtcbiAgICBjb25zdCBkaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTtcblxuICAgIGlmICh0aGlzLnNwZWMuY2xhc3NOYW1lcykge1xuICAgICAgdGhpcy5zcGVjLmNsYXNzTmFtZXMuZm9yRWFjaChjbGFzc05hbWUgPT4ge1xuICAgICAgICBkaXYuY2xhc3NMaXN0LmFkZChjbGFzc05hbWUpO1xuICAgICAgfSk7XG4gICAgfVxuXG4gICAgaWYgKHRoaXMuc3BlYy5hdHRycykge1xuICAgICAgT2JqZWN0LmVudHJpZXModGhpcy5zcGVjLmF0dHJzKS5mb3JFYWNoKG9iaiA9PiB7XG4gICAgICAgIGRpdi5zZXRBdHRyaWJ1dGUob2JqWzBdLCBvYmpbMV0pO1xuICAgICAgfSk7XG4gICAgfVxuXG4gICAgaWYgKHRoaXMuc3BlYy5pbm5lckhUTUwpIHtcbiAgICAgIGRpdi5pbm5lckhUTUwgPSB0aGlzLnNwZWMuaW5uZXJIVE1MO1xuICAgIH1cblxuICAgIGlmICh0aGlzLnNwZWMudGV4dENvbnRlbnQpIHtcbiAgICAgIGRpdi5pbm5lckhUTUwgPSB0aGlzLnNwZWMudGV4dENvbnRlbnQ7XG4gICAgfVxuXG4gICAgcmV0dXJuIGRpdjtcbiAgfVxuXG4gIHByaXZhdGUgc2V0dXBDb21tYW5kTGlzdGVuZXJzKCkge1xuICAgIHRoaXMuZG9tLmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNlZG93bicsIChlOiBNb3VzZUV2ZW50KSA9PiB7XG4gICAgICBlLnByZXZlbnREZWZhdWx0KCk7XG5cbiAgICAgIC8vIGRvbid0IGV4ZWN1dGUgaWYgbm90IGxlZnQgY2xpY2tcbiAgICAgIGlmIChlLmJ1dHRvbnMgIT09IDEpIHtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuXG4gICAgICBpZiAodGhpcy5tZW51SXRlbS50eXBlID09PSAnbWFyaycpIHtcbiAgICAgICAgY29uc3QgY29tbWFuZCA9IHRvZ2dsZU1hcmsoc2NoZW1hLm1hcmtzW3RoaXMubWVudUl0ZW0ua2V5XSk7XG4gICAgICAgIGNvbW1hbmQodGhpcy5lZGl0b3JWaWV3LnN0YXRlLCB0aGlzLmVkaXRvclZpZXcuZGlzcGF0Y2gpO1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG5cbiAgICAgIGlmICh0aGlzLm1lbnVJdGVtLnR5cGUgPT09ICdub2RlJykge1xuICAgICAgICBjb25zdCB0eXBlID0gc2NoZW1hLm5vZGVzW3RoaXMubWVudUl0ZW0ua2V5XTtcblxuICAgICAgICBpZiAoaXNMaXN0SXRlbSh0eXBlKSkge1xuICAgICAgICAgIGNvbnN0IGNvbW1hbmQgPSB0b2dnbGVMaXN0KHR5cGUsIHNjaGVtYS5ub2Rlcy5saXN0X2l0ZW0pO1xuICAgICAgICAgIGNvbW1hbmQodGhpcy5lZGl0b3JWaWV3LnN0YXRlLCB0aGlzLmVkaXRvclZpZXcuZGlzcGF0Y2gpO1xuICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICh0eXBlID09PSBzY2hlbWEubm9kZXMuaGVhZGluZykge1xuICAgICAgICAgIGNvbnN0IGNvbW1hbmQgPSB0b2dnbGVCbG9ja1R5cGUodHlwZSwgc2NoZW1hLm5vZGVzLnBhcmFncmFwaCwgeyBsZXZlbDogdGhpcy5tZW51SXRlbS5hdHRycy5sZXZlbCB9KTtcbiAgICAgICAgICBjb21tYW5kKHRoaXMuZWRpdG9yVmlldy5zdGF0ZSwgdGhpcy5lZGl0b3JWaWV3LmRpc3BhdGNoKTtcbiAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9KTtcbiAgfVxufVxuXG5jb25zdCBnZXRTZXBlcmF0b3JEb20gPSAoKTogSFRNTEVsZW1lbnQgPT4ge1xuICBjb25zdCBkaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTtcbiAgZGl2LmNsYXNzTmFtZSA9IGAke01FTlVfSVRFTV9DTEFTU05BTUV9X19TZXBlcmF0b3JgO1xuICByZXR1cm4gZGl2O1xufTtcblxuZXhwb3J0IGNvbnN0IHJlbmRlck1lbnUgPSAob3B0aW9uczogTWVudU9wdGlvbnMsIGVkaXRvclZpZXc6IEVkaXRvclZpZXcsIG1lbnVEb206IEhUTUxFbGVtZW50KSA9PiB7XG4gIGNvbnN0IHVwZGF0ZXM6IGFueVtdID0gW107XG5cbiAgY29uc3QgdG9vbGJhciA9IG9wdGlvbnMudG9vbGJhcjtcblxuICB0b29sYmFyLmZvckVhY2goKGdyb3VwOiBUb29sYmFySXRlbVtdLCB0b29sYmFySW5kZXg6IG51bWJlcik6IHZvaWQgPT4ge1xuICAgIGNvbnN0IGlzTGFzdE1lbnVHcm91cCA9IHRvb2xiYXIubGVuZ3RoIC0gMSA9PT0gdG9vbGJhckluZGV4O1xuXG4gICAgZ3JvdXAuZm9yRWFjaCgodG9vbGJhckl0ZW06IFRvb2xiYXJJdGVtLCBtZW51SW5kZXg6IG51bWJlcik6IHZvaWQgPT4ge1xuICAgICAgY29uc3QgaXNMYXN0TWVudUl0ZW0gPSBncm91cC5sZW5ndGggLSAxID09PSBtZW51SW5kZXg7XG5cbiAgICAgIC8vIHJlbmRlciBkcm9wZG93blxuICAgICAgaWYgKHR5cGVvZiB0b29sYmFySXRlbSA9PT0gJ29iamVjdCcpIHtcbiAgICAgICAgT2JqZWN0LmtleXModG9vbGJhckl0ZW0pLmZvckVhY2goKGRyb3Bkb3duR3JvdXA6IFRvb2xiYXJEcm9wZG93bkdyb3VwS2V5cykgPT4ge1xuICAgICAgICAgIGlmIChEUk9QRE9XTl9JVEVNUy5oYXMoZHJvcGRvd25Hcm91cCkpIHtcbiAgICAgICAgICAgIGNvbnN0IGRyb3Bkb3duOiBUb29sYmFyRHJvcGRvd25Hcm91cFZhbHVlcyA9IHRvb2xiYXJJdGVtW2Ryb3Bkb3duR3JvdXBdO1xuXG4gICAgICAgICAgICBjb25zdCBkcm9wZG93blZpZXcgPSBuZXcgRHJvcERvd25WaWV3KGRyb3Bkb3duR3JvdXAsIGRyb3Bkb3duLCBlZGl0b3JWaWV3LCBvcHRpb25zKTtcbiAgICAgICAgICAgIGNvbnN0IHJlbmRlcmVkID0gZHJvcGRvd25WaWV3LnJlbmRlcigpO1xuICAgICAgICAgICAgdXBkYXRlcy5wdXNoKHJlbmRlcmVkLnVwZGF0ZXMpO1xuICAgICAgICAgICAgbWVudURvbS5hcHBlbmRDaGlsZChyZW5kZXJlZC5kb20pO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBjb25zb2xlLndhcm4oJ1Vua293biBkcm9wZG93biBncm91cDonLCBkcm9wZG93bkdyb3VwKTtcbiAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgfVxuXG4gICAgICAvLyByZW5kZXIgSWNvbnNcbiAgICAgIGlmICh0eXBlb2YgdG9vbGJhckl0ZW0gPT09ICdzdHJpbmcnKSB7XG4gICAgICAgIGNvbnN0IG1lbnVJdGVtID0gbWVudUl0ZW1zTWV0YVt0b29sYmFySXRlbV07XG5cbiAgICAgICAgY29uc3QgbGFiZWxzID0gb3B0aW9ucy5sYWJlbHM7XG5cbiAgICAgICAgaWYgKG1lbnVJdGVtKSB7XG4gICAgICAgICAgY29uc3Qgc3BlYzogTWVudUl0ZW1WaWV3U3BlYyA9IHtcbiAgICAgICAgICAgIGNsYXNzTmFtZXM6IFtcbiAgICAgICAgICAgICAgTUVOVV9JVEVNX0NMQVNTTkFNRSxcbiAgICAgICAgICAgICAgYCR7TUVOVV9JVEVNX0NMQVNTTkFNRX1fX0ljb25gLFxuICAgICAgICAgICAgICBgJHtNRU5VX0lURU1fQ0xBU1NOQU1FfV9fJHttZW51SXRlbS5rZXl9YFxuICAgICAgICAgICAgXSxcbiAgICAgICAgICAgIGlubmVySFRNTDogZ2V0SWNvblN2ZyhtZW51SXRlbS5pY29uKSxcbiAgICAgICAgICAgIGF0dHJzOiB7XG4gICAgICAgICAgICAgIHRpdGxlOiBsYWJlbHNbbWVudUl0ZW0uaTE4bktleV1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9O1xuXG4gICAgICAgICAgY29uc3QgbWVudUl0ZW1WaWV3ID0gbmV3IE1lbnVJdGVtVmlldyhtZW51SXRlbSwgZWRpdG9yVmlldywgc3BlYyk7XG4gICAgICAgICAgY29uc3QgeyB1cGRhdGUsIGRvbSB9ID0gbWVudUl0ZW1WaWV3LnJlbmRlcigpO1xuXG4gICAgICAgICAgbWVudURvbS5hcHBlbmRDaGlsZChkb20pO1xuICAgICAgICAgIHVwZGF0ZXMucHVzaCh1cGRhdGUpO1xuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIGlmIChpc0xhc3RNZW51SXRlbSAmJiAhaXNMYXN0TWVudUdyb3VwKSB7XG4gICAgICAgIGNvbnN0IHNlcGVyYXRvckRvbSA9IGdldFNlcGVyYXRvckRvbSgpO1xuICAgICAgICBtZW51RG9tLmFwcGVuZENoaWxkKHNlcGVyYXRvckRvbSk7XG4gICAgICB9XG4gICAgfSk7XG4gIH0pO1xuXG4gIGNvbnN0IGNvbWJpbmVkVXBkYXRlcyA9IGZsYXREZWVwKHVwZGF0ZXMsIEluZmluaXR5KTtcblxuICByZXR1cm4ge1xuICAgIHVwZGF0ZShzdGF0ZTogRWRpdG9yU3RhdGUpIHtcbiAgICAgIGNvbWJpbmVkVXBkYXRlcy5mb3JFYWNoKCh1cGRhdGU6IChzdGF0ZTogRWRpdG9yU3RhdGUpID0+IHZvaWQpID0+IHtcbiAgICAgICAgdXBkYXRlKHN0YXRlKTtcbiAgICAgIH0pO1xuICAgIH1cbiAgfTtcbn07XG4iXX0=