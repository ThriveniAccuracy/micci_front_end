import { toggleMark } from 'prosemirror-commands';
import schema from '../../../schema';
import isNodeActive from '../../helpers/isNodeActive';
import isMarkActive from '../../helpers/isMarkActive';
import { toggleList, toggleBlockType } from '../../commands';
import { getIconSvg } from '../../../utils/icons';
import flatDeep from '../../../utils/flatDeep';
import menuItemsMeta from './meta';
var MENU_ITEM_CLASSNAME = 'NgxEditor-MenuItem';
var DROPDOWN_ITEMS = new Map();
DROPDOWN_ITEMS.set('heading', ['h1', 'h2', 'h3', 'h4', 'h5', 'h6']);
var isListItem = function (type) {
    return (type === schema.nodes.list_item ||
        type === schema.nodes.ordered_list ||
        type === schema.nodes.bullet_list);
};
var ɵ0 = isListItem;
var DropDownView = /** @class */ (function () {
    function DropDownView(dropdownGroup, dropdownFields, editorView, options) {
        this.updates = [];
        this.dropdownGroup = dropdownGroup;
        this.dropdownFields = dropdownFields;
        this.editorView = editorView;
        this.options = options;
    }
    DropDownView.prototype.getWrapperDom = function () {
        var _this = this;
        var isDropdownOpen = false;
        var dropdownWrapper = document.createElement('div');
        var labels = this.options.labels;
        dropdownWrapper.classList.add(MENU_ITEM_CLASSNAME);
        dropdownWrapper.classList.add(MENU_ITEM_CLASSNAME + "__Dropdown-Wrapper");
        // create dropdown content
        var dropdown = document.createElement('div');
        dropdown.classList.add(MENU_ITEM_CLASSNAME + "__Dropdown");
        var dropdownText = document.createElement('div');
        dropdownText.classList.add(MENU_ITEM_CLASSNAME + "__Dropdown-Text");
        dropdownText.textContent = labels[this.dropdownGroup];
        var dropdownIcon = document.createElement('div');
        dropdownIcon.classList.add(MENU_ITEM_CLASSNAME + "__Dropdown-Icon");
        dropdownIcon.innerHTML = getIconSvg('arrow_drop_down');
        dropdown.appendChild(dropdownText);
        dropdown.appendChild(dropdownIcon);
        var dropdownOpenClassName = MENU_ITEM_CLASSNAME + "__Dropdown-Wrapper-Open";
        var mouseDownHandler = function (e) {
            e.preventDefault();
            if (!dropdownWrapper.contains(e.target)) {
                closeDropdown();
            }
        };
        var openDropdown = function () {
            dropdownWrapper.classList.add(dropdownOpenClassName);
            isDropdownOpen = true;
            window.addEventListener('mousedown', mouseDownHandler);
        };
        var closeDropdown = function () {
            dropdownWrapper.classList.remove(dropdownOpenClassName);
            isDropdownOpen = false;
            window.removeEventListener('mousedown', mouseDownHandler);
        };
        dropdown.addEventListener('click', function (e) {
            e.preventDefault();
            if (!isDropdownOpen) {
                openDropdown();
            }
            else {
                closeDropdown();
            }
        });
        // create dropdown list
        var dropdownList = document.createElement('div');
        dropdownList.classList.add(MENU_ITEM_CLASSNAME + "__Dropdown-Menu");
        this.dropdownFields.forEach(function (dropdownItem) {
            var menuItem = menuItemsMeta[dropdownItem];
            var text = labels[menuItem.key];
            if (menuItem.key === 'heading') {
                text += " " + menuItem.attrs.level;
            }
            var spec = {
                classNames: [
                    MENU_ITEM_CLASSNAME + "__Dropdown-Item"
                ],
                textContent: text,
                attrs: {
                    title: text
                }
            };
            var menuItemView = new MenuItemView(menuItem, _this.editorView, spec);
            var _a = menuItemView.render(), update = _a.update, dom = _a.dom;
            // remove open class once clicked on dropdown value
            dom.addEventListener('click', function (e) {
                e.preventDefault();
                closeDropdown();
            });
            // wrapper to execute when update is called
            var dropUpdate = function (state) {
                update(state);
                var selectedClass = MENU_ITEM_CLASSNAME + "__Dropdown-Wrapper-Selected";
                // update the dropdown content heading when a class is selected
                var activeEl = dropdownList.getElementsByClassName(MENU_ITEM_CLASSNAME + "__Active");
                if (activeEl.length) {
                    var el = activeEl[0];
                    dropdownText.textContent = el.textContent;
                    dropdownWrapper.classList.add(selectedClass);
                }
                else {
                    // restore default value
                    dropdownText.textContent = labels[_this.dropdownGroup];
                    dropdownWrapper.classList.remove(selectedClass);
                }
            };
            dropdownList.appendChild(dom);
            _this.updates.push(dropUpdate);
        });
        dropdownWrapper.appendChild(dropdown);
        dropdownWrapper.appendChild(dropdownList);
        return dropdownWrapper;
    };
    DropDownView.prototype.render = function () {
        this.dom = this.getWrapperDom();
        return {
            dom: this.dom,
            updates: this.updates
        };
    };
    return DropDownView;
}());
var MenuItemView = /** @class */ (function () {
    function MenuItemView(menuItem, editorView, spec) {
        this.menuItem = menuItem;
        this.editorView = editorView;
        this.spec = spec;
    }
    MenuItemView.prototype.render = function () {
        var _this = this;
        var dom = this.dom = this.getDom();
        this.setupCommandListeners();
        var update = function (state) {
            var menuItem = _this.menuItem;
            var isActive = false;
            if (menuItem.type === 'mark') {
                var type = schema.marks[menuItem.key];
                isActive = isMarkActive(state, type);
            }
            if (menuItem.type === 'node') {
                var type = schema.nodes[menuItem.key];
                isActive = isNodeActive(state, type, menuItem.attrs);
            }
            dom.classList.toggle(MENU_ITEM_CLASSNAME + "__Active", isActive);
        };
        return {
            dom: dom,
            update: update
        };
    };
    MenuItemView.prototype.getDom = function () {
        var div = document.createElement('div');
        if (this.spec.classNames) {
            this.spec.classNames.forEach(function (className) {
                div.classList.add(className);
            });
        }
        if (this.spec.attrs) {
            Object.entries(this.spec.attrs).forEach(function (obj) {
                div.setAttribute(obj[0], obj[1]);
            });
        }
        if (this.spec.innerHTML) {
            div.innerHTML = this.spec.innerHTML;
        }
        if (this.spec.textContent) {
            div.innerHTML = this.spec.textContent;
        }
        return div;
    };
    MenuItemView.prototype.setupCommandListeners = function () {
        var _this = this;
        this.dom.addEventListener('mousedown', function (e) {
            e.preventDefault();
            // don't execute if not left click
            if (e.buttons !== 1) {
                return;
            }
            if (_this.menuItem.type === 'mark') {
                var command = toggleMark(schema.marks[_this.menuItem.key]);
                command(_this.editorView.state, _this.editorView.dispatch);
                return;
            }
            if (_this.menuItem.type === 'node') {
                var type = schema.nodes[_this.menuItem.key];
                if (isListItem(type)) {
                    var command = toggleList(type, schema.nodes.list_item);
                    command(_this.editorView.state, _this.editorView.dispatch);
                    return;
                }
                if (type === schema.nodes.heading) {
                    var command = toggleBlockType(type, schema.nodes.paragraph, { level: _this.menuItem.attrs.level });
                    command(_this.editorView.state, _this.editorView.dispatch);
                    return;
                }
            }
        });
    };
    return MenuItemView;
}());
var getSeperatorDom = function () {
    var div = document.createElement('div');
    div.className = MENU_ITEM_CLASSNAME + "__Seperator";
    return div;
};
var ɵ1 = getSeperatorDom;
export var renderMenu = function (options, editorView, menuDom) {
    var updates = [];
    var toolbar = options.toolbar;
    toolbar.forEach(function (group, toolbarIndex) {
        var isLastMenuGroup = toolbar.length - 1 === toolbarIndex;
        group.forEach(function (toolbarItem, menuIndex) {
            var isLastMenuItem = group.length - 1 === menuIndex;
            // render dropdown
            if (typeof toolbarItem === 'object') {
                Object.keys(toolbarItem).forEach(function (dropdownGroup) {
                    if (DROPDOWN_ITEMS.has(dropdownGroup)) {
                        var dropdown = toolbarItem[dropdownGroup];
                        var dropdownView = new DropDownView(dropdownGroup, dropdown, editorView, options);
                        var rendered = dropdownView.render();
                        updates.push(rendered.updates);
                        menuDom.appendChild(rendered.dom);
                    }
                    else {
                        console.warn('Unkown dropdown group:', dropdownGroup);
                    }
                });
            }
            // render Icons
            if (typeof toolbarItem === 'string') {
                var menuItem = menuItemsMeta[toolbarItem];
                var labels = options.labels;
                if (menuItem) {
                    var spec = {
                        classNames: [
                            MENU_ITEM_CLASSNAME,
                            MENU_ITEM_CLASSNAME + "__Icon",
                            MENU_ITEM_CLASSNAME + "__" + menuItem.key
                        ],
                        innerHTML: getIconSvg(menuItem.icon),
                        attrs: {
                            title: labels[menuItem.i18nKey]
                        }
                    };
                    var menuItemView = new MenuItemView(menuItem, editorView, spec);
                    var _a = menuItemView.render(), update = _a.update, dom = _a.dom;
                    menuDom.appendChild(dom);
                    updates.push(update);
                }
            }
            if (isLastMenuItem && !isLastMenuGroup) {
                var seperatorDom = getSeperatorDom();
                menuDom.appendChild(seperatorDom);
            }
        });
    });
    var combinedUpdates = flatDeep(updates, Infinity);
    return {
        update: function (state) {
            combinedUpdates.forEach(function (update) {
                update(state);
            });
        }
    };
};
export { ɵ0, ɵ1 };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWVudS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL25neC1lZGl0b3IvIiwic291cmNlcyI6WyJsaWIvcHJvc2VtaXJyb3IvcGx1Z2lucy9tZW51L21lbnUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBYWxELE9BQU8sTUFBTSxNQUFNLGlCQUFpQixDQUFDO0FBRXJDLE9BQU8sWUFBWSxNQUFNLDRCQUE0QixDQUFDO0FBQ3RELE9BQU8sWUFBWSxNQUFNLDRCQUE0QixDQUFDO0FBQ3RELE9BQU8sRUFBRSxVQUFVLEVBQUUsZUFBZSxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFFN0QsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBQ2xELE9BQU8sUUFBUSxNQUFNLHlCQUF5QixDQUFDO0FBRS9DLE9BQU8sYUFBNkIsTUFBTSxRQUFRLENBQUM7QUFFbkQsSUFBTSxtQkFBbUIsR0FBRyxvQkFBb0IsQ0FBQztBQUVqRCxJQUFNLGNBQWMsR0FBRyxJQUFJLEdBQUcsRUFBRSxDQUFDO0FBQ2pDLGNBQWMsQ0FBQyxHQUFHLENBQUMsU0FBUyxFQUFFLENBQUMsSUFBSSxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxJQUFJLENBQUMsQ0FBQyxDQUFDO0FBRXBFLElBQU0sVUFBVSxHQUFHLFVBQUMsSUFBYztJQUNoQyxPQUFPLENBQ0wsSUFBSSxLQUFLLE1BQU0sQ0FBQyxLQUFLLENBQUMsU0FBUztRQUMvQixJQUFJLEtBQUssTUFBTSxDQUFDLEtBQUssQ0FBQyxZQUFZO1FBQ2xDLElBQUksS0FBSyxNQUFNLENBQUMsS0FBSyxDQUFDLFdBQVcsQ0FDbEMsQ0FBQztBQUNKLENBQUMsQ0FBQzs7QUFFRjtJQVVFLHNCQUNFLGFBQXVDLEVBQ3ZDLGNBQTBDLEVBQzFDLFVBQXNCLEVBQ3RCLE9BQW9CO1FBTnRCLFlBQU8sR0FBRyxFQUFFLENBQUM7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QUMsT0FBTyxDQUFDLFVBQUMsTUFBb0M7Z0JBQzNELE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQztZQUNoQixDQUFDLENBQUMsQ0FBQztRQUNMLENBQUM7S0FDRixDQUFDO0FBQ0osQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgdG9nZ2xlTWFyayB9IGZyb20gJ3Byb3NlbWlycm9yLWNvbW1hbmRzJztcbmltcG9ydCB7IEVkaXRvclZpZXcgfSBmcm9tICdwcm9zZW1pcnJvci12aWV3JztcbmltcG9ydCB7IEVkaXRvclN0YXRlIH0gZnJvbSAncHJvc2VtaXJyb3Itc3RhdGUnO1xuaW1wb3J0IHsgTWFya1R5cGUsIE5vZGVUeXBlIH0gZnJvbSAncHJvc2VtaXJyb3ItbW9kZWwnO1xuXG5pbXBvcnQge1xuICBNZW51SXRlbVZpZXdTcGVjLFxuICBUb29sYmFySXRlbSxcbiAgVG9vbGJhckRyb3Bkb3duR3JvdXBLZXlzLFxuICBUb29sYmFyRHJvcGRvd25Hcm91cFZhbHVlcyxcbiAgTWVudU9wdGlvbnNcbn0gZnJvbSAnLi4vLi4vLi4vdHlwZXMnO1xuXG5pbXBvcnQgc2NoZW1hIGZyb20gJy4uLy4uLy4uL3NjaGVtYSc7XG5cbmltcG9ydCBpc05vZGVBY3RpdmUgZnJvbSAnLi4vLi4vaGVscGVycy9pc05vZGVBY3RpdmUnO1xuaW1wb3J0IGlzTWFya0FjdGl2ZSBmcm9tICcuLi8uLi9oZWxwZXJzL2lzTWFya0FjdGl2ZSc7XG5pbXBvcnQgeyB0b2dnbGVMaXN0LCB0b2dnbGVCbG9ja1R5cGUgfSBmcm9tICcuLi8uLi9jb21tYW5kcyc7XG5cbmltcG9ydCB7IGdldEljb25TdmcgfSBmcm9tICcuLi8uLi8uLi91dGlscy9pY29ucyc7XG5pbXBvcnQgZmxhdERlZXAgZnJvbSAnLi4vLi4vLi4vdXRpbHMvZmxhdERlZXAnO1xuXG5pbXBvcnQgbWVudUl0ZW1zTWV0YSwge01lbnVJdGVtTWV0YX0gZnJvbSAnLi9tZXRhJztcblxuY29uc3QgTUVOVV9JVEVNX0NMQVNTTkFNRSA9ICdOZ3hFZGl0b3ItTWVudUl0ZW0nO1xuXG5jb25zdCBEUk9QRE9XTl9JVEVNUyA9IG5ldyBNYXAoKTtcbkRST1BET1dOX0lURU1TLnNldCgnaGVhZGluZycsIFsnaDEnLCAnaDInLCAnaDMnLCAnaDQnLCAnaDUnLCAnaDYnXSk7XG5cbmNvbnN0IGlzTGlzdEl0ZW0gPSAodHlwZTogTm9kZVR5cGUpID0+IHtcbiAgcmV0dXJuIChcbiAgICB0eXBlID09PSBzY2hlbWEubm9kZXMubGlzdF9pdGVtIHx8XG4gICAgdHlwZSA9PT0gc2NoZW1hLm5vZGVzLm9yZGVyZWRfbGlzdCB8fFxuICAgIHR5cGUgPT09IHNjaGVtYS5ub2Rlcy5idWxsZXRfbGlzdFxuICApO1xufTtcblxuY2xhc3MgRHJvcERvd25WaWV3IHtcbiAgcHJpdmF0ZSBkcm9wZG93bkdyb3VwOiBUb29sYmFyRHJvcGRvd25Hcm91cEtleXM7XG4gIHByaXZhdGUgZHJvcGRvd25GaWVsZHM6IFRvb2xiYXJEcm9wZG93bkdyb3VwVmFsdWVzO1xuICBwcml2YXRlIGVkaXRvclZpZXc6IEVkaXRvclZpZXc7XG4gIHByaXZhdGUgb3B0aW9uczogTWVudU9wdGlvbnM7XG5cbiAgZG9tOiBIVE1MRWxlbWVudDtcblxuICB1cGRhdGVzID0gW107XG5cbiAgY29uc3RydWN0b3IoXG4gICAgZHJvcGRvd25Hcm91cDogVG9vbGJhckRyb3Bkb3duR3JvdXBLZXlzLFxuICAgIGRyb3Bkb3duRmllbGRzOiBUb29sYmFyRHJvcGRvd25Hcm91cFZhbHVlcyxcbiAgICBlZGl0b3JWaWV3OiBFZGl0b3JWaWV3LFxuICAgIG9wdGlvbnM6IE1lbnVPcHRpb25zXG4gICkge1xuICAgIHRoaXMuZHJvcGRvd25Hcm91cCA9IGRyb3Bkb3duR3JvdXA7XG4gICAgdGhpcy5kcm9wZG93bkZpZWxkcyA9IGRyb3Bkb3duRmllbGRzO1xuICAgIHRoaXMuZWRpdG9yVmlldyA9IGVkaXRvclZpZXc7XG4gICAgdGhpcy5vcHRpb25zID0gb3B0aW9ucztcbiAgfVxuXG4gIGdldFdyYXBwZXJEb20oKTogSFRNTEVsZW1lbnQge1xuICAgIGxldCBpc0Ryb3Bkb3duT3BlbiA9IGZhbHNlO1xuICAgIGNvbnN0IGRyb3Bkb3duV3JhcHBlciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpO1xuXG4gICAgY29uc3QgbGFiZWxzID0gdGhpcy5vcHRpb25zLmxhYmVscztcblxuICAgIGRyb3Bkb3duV3JhcHBlci5jbGFzc0xpc3QuYWRkKE1FTlVfSVRFTV9DTEFTU05BTUUpO1xuICAgIGRyb3Bkb3duV3JhcHBlci5jbGFzc0xpc3QuYWRkKGAke01FTlVfSVRFTV9DTEFTU05BTUV9X19Ecm9wZG93bi1XcmFwcGVyYCk7XG5cbiAgICAvLyBjcmVhdGUgZHJvcGRvd24gY29udGVudFxuICAgIGNvbnN0IGRyb3Bkb3duID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7XG4gICAgZHJvcGRvd24uY2xhc3NMaXN0LmFkZChgJHtNRU5VX0lURU1fQ0xBU1NOQU1FfV9fRHJvcGRvd25gKTtcblxuICAgIGNvbnN0IGRyb3Bkb3duVGV4dCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpO1xuICAgIGRyb3Bkb3duVGV4dC5jbGFzc0xpc3QuYWRkKGAke01FTlVfSVRFTV9DTEFTU05BTUV9X19Ecm9wZG93bi1UZXh0YCk7XG4gICAgZHJvcGRvd25UZXh0LnRleHRDb250ZW50ID0gbGFiZWxzW3RoaXMuZHJvcGRvd25Hcm91cF07XG5cbiAgICBjb25zdCBkcm9wZG93bkljb24gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTtcbiAgICBkcm9wZG93bkljb24uY2xhc3NMaXN0LmFkZChgJHtNRU5VX0lURU1fQ0xBU1NOQU1FfV9fRHJvcGRvd24tSWNvbmApO1xuICAgIGRyb3Bkb3duSWNvbi5pbm5lckhUTUwgPSBnZXRJY29uU3ZnKCdhcnJvd19kcm9wX2Rvd24nKTtcblxuICAgIGRyb3Bkb3duLmFwcGVuZENoaWxkKGRyb3Bkb3duVGV4dCk7XG4gICAgZHJvcGRvd24uYXBwZW5kQ2hpbGQoZHJvcGRvd25JY29uKTtcblxuICAgIGNvbnN0IGRyb3Bkb3duT3BlbkNsYXNzTmFtZSA9IGAke01FTlVfSVRFTV9DTEFTU05BTUV9X19Ecm9wZG93bi1XcmFwcGVyLU9wZW5gO1xuXG4gICAgY29uc3QgbW91c2VEb3duSGFuZGxlciA9IChlOiBNb3VzZUV2ZW50KSA9PiB7XG4gICAgICBlLnByZXZlbnREZWZhdWx0KCk7XG4gICAgICBpZiAoIWRyb3Bkb3duV3JhcHBlci5jb250YWlucyhlLnRhcmdldCBhcyBOb2RlKSkge1xuICAgICAgICBjbG9zZURyb3Bkb3duKCk7XG4gICAgICB9XG4gICAgfTtcblxuICAgIGNvbnN0IG9wZW5Ecm9wZG93biA9ICgpID0+IHtcbiAgICAgIGRyb3Bkb3duV3JhcHBlci5jbGFzc0xpc3QuYWRkKGRyb3Bkb3duT3BlbkNsYXNzTmFtZSk7XG4gICAgICBpc0Ryb3Bkb3duT3BlbiA9IHRydWU7XG4gICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignbW91c2Vkb3duJywgbW91c2VEb3duSGFuZGxlcik7XG4gICAgfTtcblxuICAgIGNvbnN0IGNsb3NlRHJvcGRvd24gPSAoKSA9PiB7XG4gICAgICBkcm9wZG93bldyYXBwZXIuY2xhc3NMaXN0LnJlbW92ZShkcm9wZG93bk9wZW5DbGFzc05hbWUpO1xuICAgICAgaXNEcm9wZG93bk9wZW4gPSBmYWxzZTtcbiAgICAgIHdpbmRvdy5yZW1vdmVFdmVudExpc3RlbmVyKCdtb3VzZWRvd24nLCBtb3VzZURvd25IYW5kbGVyKTtcbiAgICB9O1xuXG4gICAgZHJvcGRvd24uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoZTogTW91c2VFdmVudCkgPT4ge1xuICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgaWYgKCFpc0Ryb3Bkb3duT3Blbikge1xuICAgICAgICBvcGVuRHJvcGRvd24oKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGNsb3NlRHJvcGRvd24oKTtcbiAgICAgIH1cbiAgICB9KTtcblxuICAgIC8vIGNyZWF0ZSBkcm9wZG93biBsaXN0XG4gICAgY29uc3QgZHJvcGRvd25MaXN0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7XG4gICAgZHJvcGRvd25MaXN0LmNsYXNzTGlzdC5hZGQoYCR7TUVOVV9JVEVNX0NMQVNTTkFNRX1fX0Ryb3Bkb3duLU1lbnVgKTtcblxuICAgIHRoaXMuZHJvcGRvd25GaWVsZHMuZm9yRWFjaChkcm9wZG93bkl0ZW0gPT4ge1xuICAgICAgY29uc3QgbWVudUl0ZW0gPSBtZW51SXRlbXNNZXRhW2Ryb3Bkb3duSXRlbV07XG5cbiAgICAgIGxldCB0ZXh0ID0gbGFiZWxzW21lbnVJdGVtLmtleV07XG5cbiAgICAgIGlmIChtZW51SXRlbS5rZXkgPT09ICdoZWFkaW5nJykge1xuICAgICAgICB0ZXh0ICs9IGAgJHttZW51SXRlbS5hdHRycy5sZXZlbH1gO1xuICAgICAgfVxuXG4gICAgICBjb25zdCBzcGVjOiBNZW51SXRlbVZpZXdTcGVjID0ge1xuICAgICAgICBjbGFzc05hbWVzOiBbXG4gICAgICAgICAgYCR7TUVOVV9JVEVNX0NMQVNTTkFNRX1fX0Ryb3Bkb3duLUl0ZW1gXG4gICAgICAgIF0sXG4gICAgICAgIHRleHRDb250ZW50OiB0ZXh0LFxuICAgICAgICBhdHRyczoge1xuICAgICAgICAgIHRpdGxlOiB0ZXh0XG4gICAgICAgIH1cbiAgICAgIH07XG5cbiAgICAgIGNvbnN0IG1lbnVJdGVtVmlldyA9IG5ldyBNZW51SXRlbVZpZXcobWVudUl0ZW0sIHRoaXMuZWRpdG9yVmlldywgc3BlYyk7XG4gICAgICBjb25zdCB7IHVwZGF0ZSwgZG9tIH0gPSBtZW51SXRlbVZpZXcucmVuZGVyKCk7XG5cbiAgICAgIC8vIHJlbW92ZSBvcGVuIGNsYXNzIG9uY2UgY2xpY2tlZCBvbiBkcm9wZG93biB2YWx1ZVxuICAgICAgZG9tLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKGU6IE1vdXNlRXZlbnQpID0+IHtcbiAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgICBjbG9zZURyb3Bkb3duKCk7XG4gICAgICB9KTtcblxuICAgICAgLy8gd3JhcHBlciB0byBleGVjdXRlIHdoZW4gdXBkYXRlIGlzIGNhbGxlZFxuICAgICAgY29uc3QgZHJvcFVwZGF0ZSA9IChzdGF0ZTogRWRpdG9yU3RhdGUpID0+IHtcbiAgICAgICAgdXBkYXRlKHN0YXRlKTtcblxuICAgICAgICBjb25zdCBzZWxlY3RlZENsYXNzID0gYCR7TUVOVV9JVEVNX0NMQVNTTkFNRX1fX0Ryb3Bkb3duLVdyYXBwZXItU2VsZWN0ZWRgO1xuXG4gICAgICAgIC8vIHVwZGF0ZSB0aGUgZHJvcGRvd24gY29udGVudCBoZWFkaW5nIHdoZW4gYSBjbGFzcyBpcyBzZWxlY3RlZFxuICAgICAgICBjb25zdCBhY3RpdmVFbCA9IGRyb3Bkb3duTGlzdC5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lKGAke01FTlVfSVRFTV9DTEFTU05BTUV9X19BY3RpdmVgKTtcbiAgICAgICAgaWYgKGFjdGl2ZUVsLmxlbmd0aCkge1xuICAgICAgICAgIGNvbnN0IGVsID0gYWN0aXZlRWxbMF07XG4gICAgICAgICAgZHJvcGRvd25UZXh0LnRleHRDb250ZW50ID0gZWwudGV4dENvbnRlbnQ7XG4gICAgICAgICAgZHJvcGRvd25XcmFwcGVyLmNsYXNzTGlzdC5hZGQoc2VsZWN0ZWRDbGFzcyk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgLy8gcmVzdG9yZSBkZWZhdWx0IHZhbHVlXG4gICAgICAgICAgZHJvcGRvd25UZXh0LnRleHRDb250ZW50ID0gbGFiZWxzW3RoaXMuZHJvcGRvd25Hcm91cF07XG4gICAgICAgICAgZHJvcGRvd25XcmFwcGVyLmNsYXNzTGlzdC5yZW1vdmUoc2VsZWN0ZWRDbGFzcyk7XG4gICAgICAgIH1cbiAgICAgIH07XG5cbiAgICAgIGRyb3Bkb3duTGlzdC5hcHBlbmRDaGlsZChkb20pO1xuICAgICAgdGhpcy51cGRhdGVzLnB1c2goZHJvcFVwZGF0ZSk7XG4gICAgfSk7XG5cbiAgICBkcm9wZG93bldyYXBwZXIuYXBwZW5kQ2hpbGQoZHJvcGRvd24pO1xuICAgIGRyb3Bkb3duV3JhcHBlci5hcHBlbmRDaGlsZChkcm9wZG93bkxpc3QpO1xuXG4gICAgcmV0dXJuIGRyb3Bkb3duV3JhcHBlcjtcbiAgfVxuXG4gIHJlbmRlcigpIHtcbiAgICB0aGlzLmRvbSA9IHRoaXMuZ2V0V3JhcHBlckRvbSgpO1xuXG4gICAgcmV0dXJuIHtcbiAgICAgIGRvbTogdGhpcy5kb20sXG4gICAgICB1cGRhdGVzOiB0aGlzLnVwZGF0ZXNcbiAgICB9O1xuICB9XG59XG5cbmNsYXNzIE1lbnVJdGVtVmlldyB7XG4gIHByaXZhdGUgbWVudUl0ZW06IE1lbnVJdGVtTWV0YTtcbiAgcHJpdmF0ZSBlZGl0b3JWaWV3OiBFZGl0b3JWaWV3O1xuICBwcml2YXRlIHNwZWM6IE1lbnVJdGVtVmlld1NwZWM7XG5cbiAgZG9tOiBIVE1MRWxlbWVudDtcblxuICBjb25zdHJ1Y3RvcihtZW51SXRlbTogTWVudUl0ZW1NZXRhLCBlZGl0b3JWaWV3OiBFZGl0b3JWaWV3LCBzcGVjOiBNZW51SXRlbVZpZXdTcGVjKSB7XG4gICAgdGhpcy5tZW51SXRlbSA9IG1lbnVJdGVtO1xuICAgIHRoaXMuZWRpdG9yVmlldyA9IGVkaXRvclZpZXc7XG4gICAgdGhpcy5zcGVjID0gc3BlYztcbiAgfVxuXG4gIHJlbmRlcigpIHtcbiAgICBjb25zdCBkb20gPSB0aGlzLmRvbSA9IHRoaXMuZ2V0RG9tKCk7XG4gICAgdGhpcy5zZXR1cENvbW1hbmRMaXN0ZW5lcnMoKTtcblxuICAgIGNvbnN0IHVwZGF0ZSA9IChzdGF0ZTogRWRpdG9yU3RhdGUpOiB2b2lkID0+IHtcbiAgICAgIGNvbnN0IG1lbnVJdGVtID0gdGhpcy5tZW51SXRlbTtcbiAgICAgIGxldCBpc0FjdGl2ZSA9IGZhbHNlO1xuXG4gICAgICBpZiAobWVudUl0ZW0udHlwZSA9PT0gJ21hcmsnKSB7XG4gICAgICAgIGNvbnN0IHR5cGU6IE1hcmtUeXBlID0gc2NoZW1hLm1hcmtzW21lbnVJdGVtLmtleV07XG4gICAgICAgIGlzQWN0aXZlID0gaXNNYXJrQWN0aXZlKHN0YXRlLCB0eXBlKTtcbiAgICAgIH1cblxuICAgICAgaWYgKG1lbnVJdGVtLnR5cGUgPT09ICdub2RlJykge1xuICAgICAgICBjb25zdCB0eXBlOiBOb2RlVHlwZSA9IHNjaGVtYS5ub2Rlc1ttZW51SXRlbS5rZXldO1xuICAgICAgICBpc0FjdGl2ZSA9IGlzTm9kZUFjdGl2ZShzdGF0ZSwgdHlwZSwgbWVudUl0ZW0uYXR0cnMpO1xuICAgICAgfVxuXG4gICAgICBkb20uY2xhc3NMaXN0LnRvZ2dsZShgJHtNRU5VX0lURU1fQ0xBU1NOQU1FfV9fQWN0aXZlYCwgaXNBY3RpdmUpO1xuICAgIH07XG5cbiAgICByZXR1cm4ge1xuICAgICAgZG9tLFxuICAgICAgdXBkYXRlXG4gICAgfTtcbiAgfVxuXG4gIGdldERvbSgpOiBIVE1MRWxlbWVudCB7XG4gICAgY29uc3QgZGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7XG5cbiAgICBpZiAodGhpcy5zcGVjLmNsYXNzTmFtZXMpIHtcbiAgICAgIHRoaXMuc3BlYy5jbGFzc05hbWVzLmZvckVhY2goY2xhc3NOYW1lID0+IHtcbiAgICAgICAgZGl2LmNsYXNzTGlzdC5hZGQoY2xhc3NOYW1lKTtcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIGlmICh0aGlzLnNwZWMuYXR0cnMpIHtcbiAgICAgIE9iamVjdC5lbnRyaWVzKHRoaXMuc3BlYy5hdHRycykuZm9yRWFjaChvYmogPT4ge1xuICAgICAgICBkaXYuc2V0QXR0cmlidXRlKG9ialswXSwgb2JqWzFdKTtcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIGlmICh0aGlzLnNwZWMuaW5uZXJIVE1MKSB7XG4gICAgICBkaXYuaW5uZXJIVE1MID0gdGhpcy5zcGVjLmlubmVySFRNTDtcbiAgICB9XG5cbiAgICBpZiAodGhpcy5zcGVjLnRleHRDb250ZW50KSB7XG4gICAgICBkaXYuaW5uZXJIVE1MID0gdGhpcy5zcGVjLnRleHRDb250ZW50O1xuICAgIH1cblxuICAgIHJldHVybiBkaXY7XG4gIH1cblxuICBwcml2YXRlIHNldHVwQ29tbWFuZExpc3RlbmVycygpIHtcbiAgICB0aGlzLmRvbS5hZGRFdmVudExpc3RlbmVyKCdtb3VzZWRvd24nLCAoZTogTW91c2VFdmVudCkgPT4ge1xuICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuXG4gICAgICAvLyBkb24ndCBleGVjdXRlIGlmIG5vdCBsZWZ0IGNsaWNrXG4gICAgICBpZiAoZS5idXR0b25zICE9PSAxKSB7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cblxuICAgICAgaWYgKHRoaXMubWVudUl0ZW0udHlwZSA9PT0gJ21hcmsnKSB7XG4gICAgICAgIGNvbnN0IGNvbW1hbmQgPSB0b2dnbGVNYXJrKHNjaGVtYS5tYXJrc1t0aGlzLm1lbnVJdGVtLmtleV0pO1xuICAgICAgICBjb21tYW5kKHRoaXMuZWRpdG9yVmlldy5zdGF0ZSwgdGhpcy5lZGl0b3JWaWV3LmRpc3BhdGNoKTtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuXG4gICAgICBpZiAodGhpcy5tZW51SXRlbS50eXBlID09PSAnbm9kZScpIHtcbiAgICAgICAgY29uc3QgdHlwZSA9IHNjaGVtYS5ub2Rlc1t0aGlzLm1lbnVJdGVtLmtleV07XG5cbiAgICAgICAgaWYgKGlzTGlzdEl0ZW0odHlwZSkpIHtcbiAgICAgICAgICBjb25zdCBjb21tYW5kID0gdG9nZ2xlTGlzdCh0eXBlLCBzY2hlbWEubm9kZXMubGlzdF9pdGVtKTtcbiAgICAgICAgICBjb21tYW5kKHRoaXMuZWRpdG9yVmlldy5zdGF0ZSwgdGhpcy5lZGl0b3JWaWV3LmRpc3BhdGNoKTtcbiAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICBpZiAodHlwZSA9PT0gc2NoZW1hLm5vZGVzLmhlYWRpbmcpIHtcbiAgICAgICAgICBjb25zdCBjb21tYW5kID0gdG9nZ2xlQmxvY2tUeXBlKHR5cGUsIHNjaGVtYS5ub2Rlcy5wYXJhZ3JhcGgsIHsgbGV2ZWw6IHRoaXMubWVudUl0ZW0uYXR0cnMubGV2ZWwgfSk7XG4gICAgICAgICAgY29tbWFuZCh0aGlzLmVkaXRvclZpZXcuc3RhdGUsIHRoaXMuZWRpdG9yVmlldy5kaXNwYXRjaCk7XG4gICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfSk7XG4gIH1cbn1cblxuY29uc3QgZ2V0U2VwZXJhdG9yRG9tID0gKCk6IEhUTUxFbGVtZW50ID0+IHtcbiAgY29uc3QgZGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7XG4gIGRpdi5jbGFzc05hbWUgPSBgJHtNRU5VX0lURU1fQ0xBU1NOQU1FfV9fU2VwZXJhdG9yYDtcbiAgcmV0dXJuIGRpdjtcbn07XG5cbmV4cG9ydCBjb25zdCByZW5kZXJNZW51ID0gKG9wdGlvbnM6IE1lbnVPcHRpb25zLCBlZGl0b3JWaWV3OiBFZGl0b3JWaWV3LCBtZW51RG9tOiBIVE1MRWxlbWVudCkgPT4ge1xuICBjb25zdCB1cGRhdGVzOiBhbnlbXSA9IFtdO1xuXG4gIGNvbnN0IHRvb2xiYXIgPSBvcHRpb25zLnRvb2xiYXI7XG5cbiAgdG9vbGJhci5mb3JFYWNoKChncm91cDogVG9vbGJhckl0ZW1bXSwgdG9vbGJhckluZGV4OiBudW1iZXIpOiB2b2lkID0+IHtcbiAgICBjb25zdCBpc0xhc3RNZW51R3JvdXAgPSB0b29sYmFyLmxlbmd0aCAtIDEgPT09IHRvb2xiYXJJbmRleDtcblxuICAgIGdyb3VwLmZvckVhY2goKHRvb2xiYXJJdGVtOiBUb29sYmFySXRlbSwgbWVudUluZGV4OiBudW1iZXIpOiB2b2lkID0+IHtcbiAgICAgIGNvbnN0IGlzTGFzdE1lbnVJdGVtID0gZ3JvdXAubGVuZ3RoIC0gMSA9PT0gbWVudUluZGV4O1xuXG4gICAgICAvLyByZW5kZXIgZHJvcGRvd25cbiAgICAgIGlmICh0eXBlb2YgdG9vbGJhckl0ZW0gPT09ICdvYmplY3QnKSB7XG4gICAgICAgIE9iamVjdC5rZXlzKHRvb2xiYXJJdGVtKS5mb3JFYWNoKChkcm9wZG93bkdyb3VwOiBUb29sYmFyRHJvcGRvd25Hcm91cEtleXMpID0+IHtcbiAgICAgICAgICBpZiAoRFJPUERPV05fSVRFTVMuaGFzKGRyb3Bkb3duR3JvdXApKSB7XG4gICAgICAgICAgICBjb25zdCBkcm9wZG93bjogVG9vbGJhckRyb3Bkb3duR3JvdXBWYWx1ZXMgPSB0b29sYmFySXRlbVtkcm9wZG93bkdyb3VwXTtcblxuICAgICAgICAgICAgY29uc3QgZHJvcGRvd25WaWV3ID0gbmV3IERyb3BEb3duVmlldyhkcm9wZG93bkdyb3VwLCBkcm9wZG93biwgZWRpdG9yVmlldywgb3B0aW9ucyk7XG4gICAgICAgICAgICBjb25zdCByZW5kZXJlZCA9IGRyb3Bkb3duVmlldy5yZW5kZXIoKTtcbiAgICAgICAgICAgIHVwZGF0ZXMucHVzaChyZW5kZXJlZC51cGRhdGVzKTtcbiAgICAgICAgICAgIG1lbnVEb20uYXBwZW5kQ2hpbGQocmVuZGVyZWQuZG9tKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgY29uc29sZS53YXJuKCdVbmtvd24gZHJvcGRvd24gZ3JvdXA6JywgZHJvcGRvd25Hcm91cCk7XG4gICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgIH1cblxuICAgICAgLy8gcmVuZGVyIEljb25zXG4gICAgICBpZiAodHlwZW9mIHRvb2xiYXJJdGVtID09PSAnc3RyaW5nJykge1xuICAgICAgICBjb25zdCBtZW51SXRlbSA9IG1lbnVJdGVtc01ldGFbdG9vbGJhckl0ZW1dO1xuXG4gICAgICAgIGNvbnN0IGxhYmVscyA9IG9wdGlvbnMubGFiZWxzO1xuXG4gICAgICAgIGlmIChtZW51SXRlbSkge1xuICAgICAgICAgIGNvbnN0IHNwZWM6IE1lbnVJdGVtVmlld1NwZWMgPSB7XG4gICAgICAgICAgICBjbGFzc05hbWVzOiBbXG4gICAgICAgICAgICAgIE1FTlVfSVRFTV9DTEFTU05BTUUsXG4gICAgICAgICAgICAgIGAke01FTlVfSVRFTV9DTEFTU05BTUV9X19JY29uYCxcbiAgICAgICAgICAgICAgYCR7TUVOVV9JVEVNX0NMQVNTTkFNRX1fXyR7bWVudUl0ZW0ua2V5fWBcbiAgICAgICAgICAgIF0sXG4gICAgICAgICAgICBpbm5lckhUTUw6IGdldEljb25TdmcobWVudUl0ZW0uaWNvbiksXG4gICAgICAgICAgICBhdHRyczoge1xuICAgICAgICAgICAgICB0aXRsZTogbGFiZWxzW21lbnVJdGVtLmkxOG5LZXldXG4gICAgICAgICAgICB9XG4gICAgICAgICAgfTtcblxuICAgICAgICAgIGNvbnN0IG1lbnVJdGVtVmlldyA9IG5ldyBNZW51SXRlbVZpZXcobWVudUl0ZW0sIGVkaXRvclZpZXcsIHNwZWMpO1xuICAgICAgICAgIGNvbnN0IHsgdXBkYXRlLCBkb20gfSA9IG1lbnVJdGVtVmlldy5yZW5kZXIoKTtcblxuICAgICAgICAgIG1lbnVEb20uYXBwZW5kQ2hpbGQoZG9tKTtcbiAgICAgICAgICB1cGRhdGVzLnB1c2godXBkYXRlKTtcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICBpZiAoaXNMYXN0TWVudUl0ZW0gJiYgIWlzTGFzdE1lbnVHcm91cCkge1xuICAgICAgICBjb25zdCBzZXBlcmF0b3JEb20gPSBnZXRTZXBlcmF0b3JEb20oKTtcbiAgICAgICAgbWVudURvbS5hcHBlbmRDaGlsZChzZXBlcmF0b3JEb20pO1xuICAgICAgfVxuICAgIH0pO1xuICB9KTtcblxuICBjb25zdCBjb21iaW5lZFVwZGF0ZXMgPSBmbGF0RGVlcCh1cGRhdGVzLCBJbmZpbml0eSk7XG5cbiAgcmV0dXJuIHtcbiAgICB1cGRhdGUoc3RhdGU6IEVkaXRvclN0YXRlKSB7XG4gICAgICBjb21iaW5lZFVwZGF0ZXMuZm9yRWFjaCgodXBkYXRlOiAoc3RhdGU6IEVkaXRvclN0YXRlKSA9PiB2b2lkKSA9PiB7XG4gICAgICAgIHVwZGF0ZShzdGF0ZSk7XG4gICAgICB9KTtcbiAgICB9XG4gIH07XG59O1xuIl19